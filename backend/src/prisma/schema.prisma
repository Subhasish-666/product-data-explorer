// Prisma schema for MongoDB provider (FIXED)
// Matches assignment entities without validation errors

// ------------------------------------------------------------
// Generator & Datasource
// ------------------------------------------------------------

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// ------------------------------------------------------------
// Enums
// ------------------------------------------------------------

enum ScrapeTargetType {
  navigation
  category
  products
  product_detail
}

enum ScrapeStatus {
  pending
  running
  completed
  failed
}

// ------------------------------------------------------------
// navigation — id, title, slug, last_scraped_at
// ------------------------------------------------------------

model Navigation {
  id              String    @id @default(auto()) @map("_id") @db.ObjectId
  title           String
  slug            String    @unique
  last_scraped_at DateTime?

  categories      Category[]

  @@index([last_scraped_at])
}

// ------------------------------------------------------------
// category — id, navigation_id, parent_id, title, slug,
//            product_count, last_scraped_at
// ------------------------------------------------------------

model Category {
  id              String     @id @default(auto()) @map("_id") @db.ObjectId

  navigationId    String?      @db.ObjectId
  navigation      Navigation? @relation(fields: [navigationId], references: [id])

  parentId        String?     @db.ObjectId
  parent          Category?   @relation("CategoryTree", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  children        Category[]  @relation("CategoryTree")

  title           String
  slug            String      @unique
  product_count   Int         @default(0)
  last_scraped_at DateTime?

  @@index([last_scraped_at])
}

// ------------------------------------------------------------
// product — id, source_id, title, price, currency,
//           image_url, source_url, last_scraped_at
// ------------------------------------------------------------

model Product {
  id              String         @id @default(auto()) @map("_id") @db.ObjectId

  source_id       String         @unique
  title           String
  price           Float
  currency        String
  image_url       String?
  source_url      String         @unique
  last_scraped_at DateTime?

  detail          ProductDetail?
  reviews         Review[]

  @@index([last_scraped_at])
}

// ------------------------------------------------------------
// product_detail — product_id (FK), description, specs (json),
//                  ratings_avg, reviews_count
// ------------------------------------------------------------

model ProductDetail {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId

  productId      String   @unique @db.ObjectId
  product        Product  @relation(fields: [productId], references: [id])

  description    String?
  specs          Json?
  ratings_avg    Float    @default(0)
  reviews_count  Int      @default(0)
}

// ------------------------------------------------------------
// review — id, product_id, author, rating, text, created_at
// ------------------------------------------------------------

model Review {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId

  productId  String   @db.ObjectId
  product    Product  @relation(fields: [productId], references: [id])

  author     String?
  rating     Int?
  text       String?
  created_at DateTime @default(now())
}

// ------------------------------------------------------------
// scrape_job — id, target_url, target_type, status,
//              started_at, finished_at, error_log
// ------------------------------------------------------------

model ScrapeJob {
  id           String           @id @default(auto()) @map("_id") @db.ObjectId

  target_url   String
  target_type  ScrapeTargetType
  status       ScrapeStatus      @default(pending)

  started_at   DateTime?
  finished_at  DateTime?
  error_log    String?

  @@index([status])
}

// ------------------------------------------------------------
// view_history — id, user_id (optional), session_id,
//                path_json, created_at
// ------------------------------------------------------------

model ViewHistory {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId

  user_id    String?
  session_id String
  path_json  Json
  created_at DateTime @default(now())

  @@index([session_id])
  @@index([created_at])
}

